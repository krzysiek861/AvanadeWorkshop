{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "_artifactsLocation": {
      "type": "string"
    },
    "_artifactsLocationSasToken": {
      "type": "securestring"
    },
    "avanadeAppEnvironment": {
      "defaultValue": "dev",
      "metadata": {
        "description": "Environment name which will be add as prefix to all names by convention."
      },
      "minLength": 3,
      "type": "string"
    },
    "principalId": {
      "defaultValue": "",
      "metadata": {
        "description": "GUID that needs to be associate with Azure Key Vault’s objectId."
      },
      "minLength": 3,
      "type": "string"
    }
  },
  "variables": {
    "appInsightsName": "[concat(parameters('avanadeAppEnvironment'),'-avanade-workshop-app-ai')]",
    "appInsightsTemplateName": "appInsights.json",
    "appService": {
      "name": "[concat(parameters('avanadeAppEnvironment'),'-avanade-workshop-app-service')]"
    },
    "appServicePlan": {
      "name": "[concat(parameters('avanadeAppEnvironment'),'-avanade-workshop-service-plan')]",
      "skuName": "S1"
    },
    "appServicePlanTemplateName": "appServicePlan.json",
    "appServiceTemplateName": "appService.json",
    "azureFunctionName": "[concat(parameters('avanadeAppEnvironment'),'-avanade-workshop-function-app')]",
    "azureFunctionTemplateName": "azureFunction.json",
    "bingSearchName": "[concat(parameters('avanadeAppEnvironment'),'-avanade-workshop-bing')]",
    "bingSearchTemplateName": "bing.json",
    "keyVaultName": "[if(less(length(concat(parameters('avanadeAppEnvironment'),'avanadekeyvault')),24), concat(parameters('avanadeAppEnvironment'),'avanadekeyvault'),substring(concat(parameters('avanadeAppEnvironment'),'avanadekeyvault'),0,if(less(length(concat(parameters('avanadeAppEnvironment'),'avanadekeyvault')),24),length(concat(parameters('avanadeAppEnvironment'),'avanadekeyvault')),23)))]",
    "keyVaultTemplateName": "keyVault.json",
    "resourceGroupName": "[resourceGroup().name]",
    "resourceId": "[resourceGroup().id]",
    "sendgridName": "[concat(parameters('avanadeAppEnvironment'),'-avanade-workshop-sendgrid')]",
    "sendgridTemplateName": "sendgrid.json",
    "serviceBus": {
      "name": "[concat(parameters('avanadeAppEnvironment'),'-avanade-workshop-service-bus')]",
      "defaultSASKeyName": "RootManageSharedAccessKey",
      "authorizationRulesName": "[concat(parameters('avanadeAppEnvironment'),'-avanade-workshop-service-bus/RootManageSharedAccessKey')]"
    },
    "serviceBusTemplateName": "serviceBus.json",
    "storage": {
      "dataName": "[if(less(length(concat(parameters('avanadeAppEnvironment'),'avanadestorage')),24), concat(parameters('avanadeAppEnvironment'),'avanadestorage'),substring(concat(parameters('avanadeAppEnvironment'),'avanadestorage'),0,if(less(length(concat(parameters('avanadeAppEnvironment'),'avanadestorage')),24),length(concat(parameters('avanadeAppEnvironment'),'avanadestorage')),23)))]"
    },
    "storageTemplateName": "storage.json"
  },
  "resources": [
    {
      "apiVersion": "2016-09-01",
      "name": "appInsightsTemplate",
      "properties": {
        "mode": "Incremental",
        "parameters": {
          "name": { "value": "[variables('appInsightsName')]" }
        },
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/', variables('appInsightsTemplateName'), '?', parameters('_artifactsLocationSasToken'))]",
          "contentVersion": "1.0.0.0"
        }
      },
      "type": "Microsoft.Resources/deployments"
    },
    {
      "apiVersion": "2016-09-01",
      "name": "appServicePlanTemplate",
      "properties": {
        "mode": "Incremental",
        "parameters": {
          "appServicePlan": { "value": "[variables('appServicePlan')]" }
        },
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/', variables('appServicePlanTemplateName'), '?', parameters('_artifactsLocationSasToken'))]",
          "contentVersion": "1.0.0.0"
        }
      },
      "type": "Microsoft.Resources/deployments"
    },
    {
      "apiVersion": "2016-09-01",
      "dependsOn": [
        "appInsightsTemplate",
        "appServicePlanTemplate",
        "storageDataTemplate"
      ],
      "name": "azureFunctionTemplate",
      "properties": {
        "mode": "Incremental",
        "parameters": {
          "name": { "value": "[variables('azureFunctionName')]" },
          "hostingPlanName": { "value": "[variables('appServicePlan').name]" },
          "storageAccountName": { "value": "[variables('storage').dataName]" },
          "applicationInsightsName": { "value": "[variables('appInsightsName')]" }
        },
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/', variables('azureFunctionTemplateName'), '?', parameters('_artifactsLocationSasToken'))]",
          "contentVersion": "1.0.0.0"
        }
      },
      "type": "Microsoft.Resources/deployments"
    },
    {
      "apiVersion": "2016-09-01",
      "dependsOn": [
        "appInsightsTemplate",
        "appServicePlanTemplate",
        "serviceBusTemplate",
        "storageDataTemplate"
      ],
      "name": "appServiceTemplate",
      "properties": {
        "mode": "Incremental",
        "parameters": {
          "appService": { "value": "[variables('appService')]" },
          "appSettings": {
            "value": [
              {
                "name": "serviceBusScheme",
                "value": "sb"
              },
              {
                "name": "serviceBusServiceName",
                "value": "[variables('serviceBus').name]"
              },
              {
                "name": "serviceBusSharedAccessKeyName",
                "value": "[variables('serviceBus').defaultSASKeyName]"
              },
              {
                "name": "serviceBusSharedAccessKeyValue",
                "value": "[reference('serviceBusTemplate').outputs.primaryKey.value]"
              },
              {
                "name": "Azure.ServiceBus.ReThrowInterval",
                "value": "10"
              },
              {
                "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                "value": "[reference('appInsightsTemplate').outputs.instrumentationKey.value]"
              }
            ]
          },
          "connectionStrings": {
            "value": [
              {
                "name": "AzureWebJobsDashboard",
                "connectionString": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storage').dataName, ';AccountKey=', reference('storageDataTemplate').outputs.accountKey.value)]",
                "type": 3
              },
              {
                "name": "AzureWebJobsStorage",
                "connectionString": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storage').dataName, ';AccountKey=', reference('storageDataTemplate').outputs.accountKey.value)]",
                "type": 3
              },
              {
                "name": "AzureWebJobsServiceBus",
                "connectionString": "[reference('serviceBusTemplate').outputs.primaryConnectionString.value]",
                "type": 3
              }
            ]
          },
          "serverFarmId": { "value": "[reference('appServicePlanTemplate').outputs.appServicePlanId.value]" }
        },
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/', variables('appServiceTemplateName'), '?', parameters('_artifactsLocationSasToken'))]",
          "contentVersion": "1.0.0.0"
        }
      },
      "type": "Microsoft.Resources/deployments"
    },
    {
      "apiVersion": "2016-09-01",
      "name": "bingSearchTemplate",
      "properties": {
        "mode": "Incremental",
        "parameters": {
          "name": { "value": "[variables('bingSearchName')]" }
        },
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/', variables('bingSearchTemplateName'), '?', parameters('_artifactsLocationSasToken'))]",
          "contentVersion": "1.0.0.0"
        }
      },
      "type": "Microsoft.Resources/deployments"
    },
    {
      "apiVersion": "2016-09-01",
      "dependsOn": [
        "appInsightsTemplate",
        "appServiceTemplate",
        "appServicePlanTemplate",
        "bingSearchTemplate",
        "serviceBusTemplate",
        "storageDataTemplate"
      ],
      "name": "keyVaultTemplateName",
      "properties": {
        "mode": "Incremental",
        "parameters": {
          "name": { "value": "[variables('keyVaultName')]" },
          "principalId": { "value": "[parameters('principalId')]" },
          "appServiceName": { "value": "[variables('appService').name]" },
          "appInsightsInstrumentationKey": { "value": "[reference('appInsightsTemplate').outputs.instrumentationKey.value]" },
          "bingSearchPrimaryKey": { "value": "[reference('bingSearchTemplate').outputs.primaryKey.value]" },
          "bingSearchQueryKey": { "value": "[reference('bingSearchTemplate').outputs.queryKey.value]" },
          "serviceBusServiceName": { "value": "[variables('serviceBus').name]" },
          "serviceBusSharedAccessKeyName": { "value": "[variables('serviceBus').defaultSASKeyName]" },
          "serviceBusSharedAccessKeyValue": { "value": "[reference('serviceBusTemplate').outputs.primaryKey.value]" },
          "storageAccountKey": { "value": "[reference('storageDataTemplate').outputs.accountKey.value]" },
          "storageConnectionString": { "value": "[reference('storageDataTemplate').outputs.connectionString.value]" }
        },
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/', variables('keyVaultTemplateName'), '?', parameters('_artifactsLocationSasToken'))]",
          "contentVersion": "1.0.0.0"
        }
      },
      "type": "Microsoft.Resources/deployments"
    },
    {
      "apiVersion": "2016-09-01",
      "name": "sendgridTemplateName",
      "properties": {
        "mode": "Incremental",
        "parameters": {
          "name": { "value": "[variables('sendgridName')]" },
          "subscriptionId": { "value": "[subscription().subscriptionId]" }
        },
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/', variables('sendgridTemplateName'), '?', parameters('_artifactsLocationSasToken'))]",
          "contentVersion": "1.0.0.0"
        }
      },
      "type": "Microsoft.Resources/deployments"
    },
    {
      "apiVersion": "2016-09-01",
      "name": "serviceBusTemplate",
      "properties": {
        "mode": "Incremental",
        "parameters": {
          "serviceBus": { "value": "[variables('serviceBus')]" }
        },
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/', variables('serviceBusTemplateName'), '?', parameters('_artifactsLocationSasToken'))]",
          "contentVersion": "1.0.0.0"
        }
      },
      "type": "Microsoft.Resources/deployments"
    },
    {
      "apiVersion": "2016-09-01",
      "name": "storageDataTemplate",
      "properties": {
        "mode": "Incremental",
        "parameters": {
          "name": { "value": "[variables('storage').dataName]" }
        },
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'), '/', variables('storageTemplateName'), '?', parameters('_artifactsLocationSasToken'))]",
          "contentVersion": "1.0.0.0"
        }
      },
      "type": "Microsoft.Resources/deployments"
    }
  ],
  "outputs": {
  }
}